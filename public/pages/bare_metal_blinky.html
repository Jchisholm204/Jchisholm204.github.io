<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=5,IE=9" ><![endif]-->
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>STM32 Blinky</title>
    <link rel="shortcut icon" href="../assets/favicon.ico?" />
    <link href="../styles/article_header.css" rel="stylesheet" />
    <link href="../styles/article.css" rel="stylesheet" />
    <link href="../styles/gallery.css" rel="stylesheet" />
    <link rel="stylesheet" href="../styles/github-dark.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RF183RGL9W"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RF183RGL9W');
</script>
<body id="body">
    <script src="../scripts/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <aside id="topbar">
        <a id="topbar-header" href="../projects_index.html">
            <img src="../assets/jc_boc.png" alt="JClogo" id="jc_logo" />
        </a>
        <ul id="contact">
            <li id="github">
                <a href="http://github.com/jchisholm204">
                    <img src="../assets/GitHub.png" alt="git" />
                </a>
            </li>
            <li id="linkedin">
                <a href="https://www.linkedin.com/in/jacob-chisholm-a2a007253/">
                    <img src="../assets/linkedin.png" alt="linkedin" />
                </a>
            </li>
            <li id="email">
                <a href="mailto:jacobchisholm1010@gmail.com">
                    <img src="../assets/mail.png" alt="mail" />
                </a>
            </li>
            <li id="instagram">
                <a href="https://www.instagram.com/jchisholm204/">
                    <img src="../assets/instagram.jpg" alt="insta" />
                </a>
            </li>
        </ul>
    </aside>

    <div id="top-img" class="headline" style="background-image: url(../assets/baremetal/q23mockecu.jpg)">
        <div class="container">
            <h1>STM32 Bare Metal</h1>
            <p class="description">Making a simple blinky program</p>
        </div>
    </div>
    <div id="page-content">
        <div class="paragraph">
            <h2 style="padding: 0px;">Inspiration</h2>
            <p>
                Fascinated with how the Arduino HAL (Hardware Abstraction Layer) works, I decided to learn a little more about bare metal programming.
                This project is rather simple, but provided me with some basic insight into the inner workings of not only how the Arduino HAL works,
                but also the basics of how micro-controllers operate.
            </p>
            <h2>Introduction</h2>
                Having no idea where to start on this project, I followed this
                <a href="https://github.com/cpq/bare-metal-programming-guide">Bare Metal Programming Guide</a>
                I found on GitHub written by Sergey Lyubka. The guide covered everything I needed to know with the exception of a few things.
                First, the guide was written for using an F429, I only have access to an F446, therefore some of the registers had to be changed.
                Secondly, I did not have access to an ST-Link while working on this tutorial, therefore I had to use the ARM-GDB command line utility
                instead of the ST-Link utility. I should also note that I did not complete the full tutorial. Initially I completed up to step 5 and
                later completed something similar to step 6 on my own.
                I did this simply because I did not feel that step 7 would strongly contribute to my learning.
                Please note that the steps given 
            </p>
            <h2>Step 0: Boot</h2>
            <p>
                The first step in programming a microcontroller is to write the boot and linker scripts.</br>
                The linker script tells the linker where the bounds of the memory are on the specific microcontroller.
                This ensures two things: First, that your compiled binary will have data in the correct locations, and
                secondly that your compiled binary will not exceed the size of the flash memory.</br>
                The boot script is equally important. It serves the purpose of transferring data out of flash
                and into ram. It also sets up all of the interrupt handlers. <br>
                For this project, I wrote my own startup and linker scripts in order to understand them but
                they are also given out by the chip manufacturer as part of the CMSIS files. <br>
            </p>
            <h2>Blinking an LED</h2>
            <p>
                Now that the microcontroller starts up, we can give it some code to do something. In
                this example, we will blink an LED. <br>
                Before we can get to the fun part, we need to create some macros that will help us.
                First is the "PIN" define. In order to address a GPIO pin, two pieces of information
                are needed: The pin bank and the number. All pins on STM32 microcontrollers are organized
                in groups for power saving. By default, these groups are all turned off to save power.
                Each of these things can be stored as a single 8 bit integer, or, for ease of use, packaged
                into a single 16 bit integer. The "PIN" definition stores the bank in the upper half of the 16
                and the pin number in the lower half.
            </p>
            <pre><code>
// Package a pin bank (U8) and pin number (U8) into single package (U16)
#define PIN(bank, num) ((((bank) - 'A') << 8) | (num))
// Retrieve pin number (U8) from pin package (U16)
#define PINNO(pin) (pin & 255)
// Retrieve pin bank (U8) from pin package (U16)
#define PINBANK(pin) (pin >> 8)
            </code></pre>
            <p>
                Now that we have created a method to easily store pins, we need to access the GPIO register
                on the chip. This can be done by creating a structure that exactly matches that of the STM32F446
                datasheet, and typecasting the structure to start at the memory address also given by the datasheet.
                I have also packaged this into a define that can be used for any GPIO bank.
            </p>
            <pre class="hljs language-cpp"><code>
// struct for referencing GPIO memory (ex. GPIO bank A)
struct gpio {
    volatile uint32_t MODER, OTYPER, OSPEEDR, PUPDR, IDR, ODR, BSRR, LKR, AFR[2];
};

// Reference memory address for STM32F446RE GPIO banks
#define GPIO(bank) ((struct gpio *) (0x40020000 + 0x400 * (bank)))
            </code></pre>
            <p>
                The same thing was done in the boot section of the tutorial for the RCC register, but I
                also link it below as I reference it later.
            </p>
            <pre class="hljs language-cpp"><code>
// Struct for accessing STM32F446 Power Control Module
struct rcc {
    volatile uint32_t CR, PLLCFGR, CFGR, CIR, AHB1RSTR, AHB2RSTR, AHB3RSTR,
        RESERVED0, APB1RSTR, APB2RSTR, RESERVED1[2], AHB1ENR, AHB2ENR, AHB3ENR,
        RESERVED2, APB1ENR, APB2ENR, RESERVED3[2], AHB1LPENR, AHB2LPENR,
        AHB3LPENR, RESERVED4, APB1LPENR, APB2LPENR, RESERVED5[2], BDCR, CSR,
        RESERVED6[2], SSCGR, PLLI2SCFGR;
};

// STM32F446RE RCC Memory Addr
#define RCC ((struct rcc *) 0x40023800)
            </code></pre>
            <p>
                Now I have created methods to access some registers, I will write a simple bit of code to
                write a digital value to a GPIO pin. First, we must obtain access to the register that controls
                the bank for our pin. This can be done with the "GPIO" and "PINBANK" defines created earlier.
                Once we have access to the correct register, we can either set its output to 1, or reset it to 0.
                Set or reset depends on writing to either the upper or lower half of the control register as 
                defined in the STM32 Programmers Manual.
            </p>
            <pre><code>
/**
* @brief Write a Digital Value to a pin
* 
* @param pin PIN(bank, number)
* @param value <true, false>
*/
static inline void gpio_write(uint16_t pin, bool value) {
    struct gpio *gpio = GPIO(PINBANK(pin));
    gpio->BSRR = (1U << PINNO(pin)) << (value ? 0 : 16);
}
            </code></pre>
            <p>
                With all of our functions created, the last step is to enable the correct gpio bank
                and write some code that blinks the led. My main code has been referenced below.
                Included in this code is a counter delay function. This simply acts as a delay by blocking
                the main loop and executing a large count down. It is far from the best method to implement
                a delay but is simple and works for this purpose.
            </p>
            <pre class="hljs language-cpp"><code>
/**
* @brief Simple Counter delay
* 
* @param count countto
*/
static inline void count_delay(volatile uint32_t count) {
    while(count--) (void) 0;
}

int main(void){
    uint16_t led1 = PIN('B', 0);
    RCC->AHB1ENR |= BIT(PINBANK(led1));
    gpio_set_mode(led1, OUTPUT);
    for(;;) {
        gpio_write(led1, true);
        count_delay(999999);
        gpio_write(led1, false);
        count_delay(999999);
    }
    return 0;
}
            </code></pre>
            <h2>The Result</h2>
            <div class="gallery">
                <div class="gallery row">
                <video controls style="height: auto; width: 60%; border-radius: 4px;">
                    <source src="../assets/baremetal/1hz_blink_alternate.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                    <br>
                    This is a video of the original lab my friend sent me.
                </video>
                </div>
            </div>
        </div>
        </div>
    </div>
    <footer>&copy; Jacob Chisholm, 2022</footer>
</body>
</html>